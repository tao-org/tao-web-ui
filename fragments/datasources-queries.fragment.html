<style>
.content-wrapper{position:relative}

.box-body.chat{padding:10px}

.fa-plus-plus::before{color:gray}
.fa-plus-plus::after{color:black;content:"\f067";position:absolute;left:9px;top:12px;text-shadow:-1px -1px 0 white}

.nodes-item-core-box{position:relative;z-index:1;border:1px solid #96c2da;border-top:2px solid #3c8dbc}
.nodes-item-core-box .box-bottom.with-line{border-top:0;border-bottom:6px double rgba(0, 100, 160, 0.1);padding:0 0 15px 0}
.nodes-item-core-box .box-top .box-title{font-size:1.6em}
.nodes-item-core-box .box-top .box-subtitle{margin-bottom:0}
.nodes-item-core-box .box-top .box-text{font-size:1.2em}
.nodes-item-core-box .box-top-tags{top:-12px;right:10px}
.nodes-item-core-box .box-top-tags span{padding:0 8px;background-color:white;font-weight:600;color:#4693bf}
.query-group     .nodes-item-core-box .box-top-tags span{background-color:#4693bf;color:white;border:4px double white}
.query-component .nodes-item-core-box .box-top-tags span{background-color:#ecf7fd}

.query-group .nodes-item-core-box{border-top-left-radius:40px;border-top-right-radius:20px;background-color:#c6e7fb}
.query-group>div::before,.query-group>div::after{content:"";position:absolute;border-radius:4px;width:120px;height:50%;max-width:30%;background-color:#70aed2}
.query-group>div::before{top:-10px;border-radius:15px 25px 4px 4px}
.query-group>div::after{background-color:#ecf7fd;left:19px;top:4px;width:90px;border-top:2px solid #3c8dbc;border-left:1px solid #70aed2}
.query-component .nodes-item-core-box{background-color:#ecf7fd}
.query-component>div::before{content:"";position:absolute;border-radius:4px;width:90px;height:50%;max-width:30%;background-color:#ecf7fd;bottom:13px;left:30px;border:1px solid #b0d7ec}

.nodes-item-core-box .box-bottom .btn-nodeop:disabled{opacity:0.3}
</style>

<div id="myModalNodes" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true"></div>

<!-- Content Header (Page header) -->
<section class="content-header tao-async-ph">
    <h1>Queries/Collections<small>Here you can find the list of saved parameterized queries and collections of queries.</small></h1>
    <ol class="breadcrumb">
        <li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
        <li class="active">Queries</li>
    </ol>
</section><!-- /Content Header (Page header) -->
<!-- Main content -->
<section class="content">
	<div id="panel-topo-wrapper" class="row">
		<div class="col-md-12">
			<!-- Custom Tabs -->
			<div class="nav-tabs-custom">
				<ul class="nav nav-tabs hidden-xs">
					<li class="role role-admin active"><a href="#panel-queries" data-toggle="tab" data-action="all_queries" aria-expanded="true">Queries</a></li>
					<li class="pull-right"><a href="#" class="btn text-muted btn-action" data-action="refresh" data-toggle="tooltip" title="" data-original-title="Refresh"><i class="fa fa-refresh"></i></a></li>
				</ul>
				<div class="tab-content">
					<div class="tab-pane active" id="panel-nodes">
						<div class="row">
							<div class="col-md-12" id="list-master-controls">
								<div class="box-tools pull-left">
									<button class="btn btn-master-tool text-black" data-action="op-plus" data-toggle="tooltip" data-original-title="Add query"><i class="fa fa-plus"></i></button>
									<button class="btn btn-master-tool text-black" data-action="op-plus-collection" data-toggle="tooltip" data-original-title="Add query collection"><i class="fa fa-plus fa-plus-plus"></i></button>
								</div>
                                <div class="box-tools pull-left">
                                    <button class="btn btn-master-tool text-black" data-action="op-filter" data-toggle="tooltip" data-original-title="Filter by tags"><i class="fa fa-filter"></i><span class="label label-warning val-count-filters" style="display:none;">0</span></button>
                                </div>
								<div class="box-tools pull-left">
									<form class="search-container" action="">
										<input id="search-box" type="text" class="search-box" name="q" placeholder="Search by name" />
										<label for="search-box"><i class="fa fa-search search-icon" aria-hidden="true"></i></label>
										<input type="submit" id="search-submit" />
									</form>
								</div>
								<div class="box-tools pull-right">
                                    <button class="btn btn-master-tool text-black" data-action="refresh-list" data-toggle="tooltip" data-original-title="Refresh"><i class="fa fa-refresh fa-spin-hover"></i></button>
									<button class="btn btn-master-tool text-black" data-action="view-list" data-toggle="tooltip" data-original-title="List view"><i class="fa fa-list"></i></button>
									<button class="btn btn-master-tool text-black" data-action="view-table" data-toggle="tooltip" data-original-title="Table view"><i class="fa fa-table"></i></button>
								</div>
							</div>
						</div>
                        <div class="row">
                            <div class="col-md-12 like collapse">
                                <span data-tag="tag">Label like: <strong class="val-q"></strong>&nbsp;<i class="fa fa-times fa-fw clear-search" aria-hidden="true"></i></span>
                            </div>
                            <div class="col-md-12 tags collapse">
                                <span class="collapse" data-tag="tag">tag<i class="fa fa-check fa-fw" aria-hidden="true"></i></span>
                            </div>
                        </div>
						<div class="row" id="panel-queries">
							<div class="col-sm-12">
								<div class="box box-success">
									<div class="box-header">
										<i class="fa fa-cubes"></i>
										<h3 class="box-title">Queries -  <span class="val-itemfrom">0</span> to <span class="val-itemto">0</span> of <span class="val-itemscount">0</span></h3>
										<div class="box-tools pull-right nppaginatedcells-order collapse" data-toggle="tooltip" title="Change order"></div>
									</div>
									<div class="nppaginatedcells-empty callout callout-empty">
										<p>Queries list is empty. <span class="results-empty">You do not have any query.</span><span class="filter-results-empty collapse">Your current selection did not return any result.</span></p>
									</div>
									<div class="box-body chat users-box" id="nodes-box">
										<div class="nppaginatedcells-panel-body">
										</div>
										<div class="cell-templates collapse">
											<core-cell-grid id="node-master-template" class="collapse core-cell-box">
												<div class="col-md-3 col-sm-6">
													<div class="nodes-item-core-box">
														<div class="box-top-tags"></div>
														<div class="box-top">
															<div class="box-title"><span class="val-dsLabel"></span></div>
															<div class="box-subtitle" style="min-height:35px;max-height:35px;"><span class="val-label"></span></div>
															<div class="box-icon"><i class="fa fa-cube"></i></div>
														</div>
														<div class="box-bottom with-line">
															<div class="pocket">
																<button type="button" class="btn btn-primary btn-sm btn-flat btn-action btn-nodeop" data-action="edit"><i class="fa fa-pencil fa-fw" aria-hidden="true"></i><span class="span-muted collapse">&nbsp;Edit</span></button>
																<button type="button" class="btn btn-primary btn-sm btn-flat btn-action btn-nodeop" data-action="delete"><i class="fa fa-trash-o fa-fw" aria-hidden="true"></i><span class="span-muted collapse">&nbsp;Delete</span></button>
															</div>
														</div>
													</div>
												</div>
											</core-cell-grid>
											<core-cell-list id="node-master-template-list" class="collapse core-cell-box">
												<div class="col-md-12 col-sm-12">
													<div class="nodes-item-core-box">
														<div class="box-top-tags"></div>
														<div class="box-top">
															<div class="box-title"><span class="val-dsLabel"></span></div>
															<div class="box-subtitle"><span class="val-label"></span></div>
															<div class="box-icon"><i class="fa fa-cube"></i></div>
														</div>
														<div class="row">
															<div class="col-sm-12 col-xs-12">
																<div class="text-right">
																	<button type="button" class="btn btn-primary btn-sm btn-flat btn-action btn-nodeop" data-action="edit"><i class="fa fa-pencil fa-fw" aria-hidden="true"></i><span class="span-muted">&nbsp;Edit</span></button>
																	<button type="button" class="btn btn-primary btn-sm btn-flat btn-action btn-nodeop" data-action="delete"><i class="fa fa-trash-o fa-fw" aria-hidden="true"></i><span class="span-muted">&nbsp;Delete</span></button>
																</div>
															</div>
														</div>
													</div>
												</div>
											</core-cell-list>
										</div>
									</div>
									<div class="box-footer clearfix no-border">
										<div class="box-tools pull-right"><ul class="nppaginatedcells-panel-pagination pagination pagination-sm inline"></ul></div>
										<div class="box-notification"><p><span>List updated</span></p></div>
									</div>
								</div>
							</div>
						</div>
					</div><!-- /.tab-pane -->
				</div><!-- /.tab-content -->
			</div><!-- /.nav-tabs-custom -->
		</div>
	</div>
</section><!-- /.content -->

<link rel="stylesheet" href="./assets/libs/jQuery-datepicker/jquery-ui.theme.css" type="text/css" />
<link rel="stylesheet" href="./assets/libs/jQuery-datepicker/jquery-ui.structure.css" type="text/css" />
<link rel="stylesheet" href="./assets/libs/jQuery-datepicker/jquery-ui.css" type="text/css" />

<script src="./assets/libs/jQuery-datepicker/jquery-ui.js" type="text/javascript"></script>
<script src="./assets/libs/jQuery/paginathing.js" type="text/javascript"></script>

<script type="text/javascript" src="./assets/libs/openlayers/ol-poly.js"></script>

<script>
	var urls = [
			baseRestApiURL + "datasource/user/group/",
			baseRestApiURL + "datasource/query/"
		];
	
	var panelComp = $('#panel-nodes').npPaginatedCells({
		headerUser : taoUserProfile.username,
		url        : urls,
		viewMode   : prefferences.viewMode,
		itemsOnPage: 12,
		order      :[
						{ "label": "Name ascending" , "objAttributeName": "customField", "direction": "ASC", "default": true },
						{ "label": "Name descending", "objAttributeName": "customField", "direction": "DSC" },
						{ "label": "Date ascending" , "objAttributeName": "modified", "direction": "ASC" },
						{ "label": "Date descending", "objAttributeName": "modified", "direction": "DSC" }
					],
		filterAttribute: "customField",
		doDataPreprocessing: function (data) {
			var trimmed = [];
			$.each(data, function (index, item) {
				var isCollection = typeof item.dataSourceComponents !== "undefined";
				var isQueryInCollection = typeof item.componentId === "string";
				// Add extra custom fields
				item.tags        = isQueryInCollection ? ["component"] : (isCollection ? ["collection"] : ["query"]);
				item.dsLabel     = isCollection ? "Query collection" : item.sensor + " - " + item.dataSource;
				item.customField = item.dsLabel.replace(" - ", " ") + " "  + item.label;
				if (isQueryInCollection) {
					trimmed.push(item);
				} else {
					trimmed.push(item);
				}
			});
			return trimmed;
		},
		doAction: function(action, args){
			myModalNodesOpShow(action, (typeof args === "undefined") ? args : args.dna);
		},
		doCustomRender: function($elClone, elX){
			if (elX.tags[0] === "collection") {
				$elClone.addClass("query-group");
				$(".fa-cube", $elClone).removeClass("fa-cube").addClass("fa-cubes");
			} else if (elX.tags[0] === "component" ) {
				$elClone.addClass("query-component");
				$("button[data-action='delete']", $elClone).prop({ disabled: true });
			}
		}
	});
	
	function myModalNodesOpShow(action, dna) {
		var isCollection = action.indexOf("collection") >= 0 || (dna && dna.tags[0] === "collection");
		
		// Open add/edit page
		if (action.indexOf("plus") >= 0 || action === "edit") {
			$.ajax({
				url: "./fragments/datasource-queries-plus.fragment.html?" + Math.random(),
				async: false,
				success: function(result) {
					if (result !== "") {
						var $modal = $("#myModalNodes");
						
						// Prepare modal data
						var oAction = (action === "edit") ? "edit" : "add";
						var oDna = $.extend(true, {}, dna);
						// Remove all extra custom fields added in data preprocessing stage (tags, dsLabel, customField)
						delete oDna["tags"];
						delete oDna["dsLabel"];
						delete oDna["customField"];
						$modal.data({ isCollection: isCollection, action: oAction, dna: oDna });
						
						$modal.html(result);
						$modal.modal({ backdrop: false, keyboard: false });
						$modal.modal("show");
						$modal.off('hidden.bs.modal');
						$modal.on('hidden.bs.modal', function () {
							// Kill all datepicker controls when parent window is closed
							$("#" + $.datepicker.dpDiv.attr("id")).remove();
							$(this).html("");
							// Refresh data
							panelComp.refreshData();
						});
					}
				},
				error: function (jqXHR, textStatus, errorThrown) {
					alert("Could not open the add/edit page. An error occurred while retrieving data from server.");
				}
			});
		// Remove query/collection
		} else if (action === "delete") {
			if (typeof dna.id === "undefined") {
				showMsg("Unable to perform requested action. Please try again later.", "ERROR");
			} else {
				$('#confirm-dialog').modal("confirm", {
					msg: "Are you sure you want to delete this element: " + dna.label + "?",
					callbackConfirm: function () {
						$.ajax({
							cache   : false,
							url     : isCollection ? (baseRestApiURL + "datasource/user/group/remove?groupId=" + dna.id) : (baseRestApiURL + "datasource/query/" + dna.id + "/"),
							dataType: 'json',
							type    : 'DELETE',
							headers : {
								"Accept": "application/json",
								"Content-Type": "application/json",
								"X-Auth-Token": window.tokenKey
							},
							error: function (jqXHR, textStatus, errorThrown) {
								if(jqXHR.status === 500 ) {
									showMsg("Unable to perform requested action. Please try again later.", "ERROR");
								} else {
									alert('An error has occurred, please try again or contact app admin.');
								}
							},
							success: function (data) {
								showMsg("Object successfully deleted.", "SUCCESS");
								panelComp.refreshData();
							}
						});
					},
					callbackCancel : function () {}
				});
			}
		}
    };

//# sourceURL=filename.js
</script>