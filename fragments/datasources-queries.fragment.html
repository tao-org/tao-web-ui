<style>
#myModalEditProductSets>.modal-dialog{width:50%;}

.content-wrapper-edit-query{position:relative}

.box-body.chat{padding:10px}
/* ======== BUTTONS ======== */
.fa-plus-plus::before{color:gray}
.fa-plus-plus::after{color:black;content:"\f067";position:absolute;left:9px;top:12px;text-shadow:-1px -1px 0 white}
/* ======== BOX ELEMENTS ======== */
.nodes-item-core-box{position:relative;z-index:1;border:1px solid #96c2da;border-top:2px solid #3c8dbc}
.nodes-item-core-box .box-top .box-title{font-size:1.2em;font-weight:600;margin-bottom:5px}
.nodes-item-core-box .box-top .box-subtitle{margin-bottom:5px;white-space:nowrap;text-overflow:ellipsis;overflow-x:hidden}
.nodes-item-core-box .box-top .box-text{margin:0;padding-left:10px;line-height:16px;overflow-y:auto;overflow-x:hidden;white-space:nowrap;text-overflow:ellipsis;width:80%;width:calc(100% - 65px)}
.nodes-item-core-box .box-bottom.with-line{border-top:0;position:absolute;right:15px;bottom:30px;width:auto}
/* ======== TAGS ======== */
.nodes-item-core-box .box-top-tags{top:-12px;right:10px}
.nodes-item-core-box .box-top-tags span{padding:0 8px;background-color:white;font-weight:600;color:#4693bf}
.query-group     .nodes-item-core-box .box-top-tags span{background-color:#4693bf;color:white;border:4px double white}
.query-component .nodes-item-core-box .box-top-tags span{background-color:#ecf7fd}
/* ======== BOX APPEARANCE ======== */
.query-group .nodes-item-core-box{border-top-left-radius:40px;border-top-right-radius:20px;background-color:#c6e7fb}
.query-group>div::before,.query-group>div::after{content:"";position:absolute;border-radius:4px;width:120px;height:50%;max-width:30%;background-color:#70aed2}
.query-group>div::before{top:-10px;border-radius:15px 25px 4px 4px}
.query-group>div::after{background-color:#ecf7fd;left:19px;top:4px;width:90px;border-top:2px solid #3c8dbc;border-left:1px solid #70aed2}
.query-component .nodes-item-core-box{background-color:#ecf7fd}
.query-component>div::before{content:"";position:absolute;border-radius:4px;width:90px;height:50%;max-width:30%;background-color:#ecf7fd;bottom:13px;left:30px;border:1px solid #b0d7ec}

/* ======== SELECT2 APPEARANCE ======== */
#myModalEditProductSets .select2-container--default .select2-selection--multiple{border-color:#d2d6de;line-height:2rem;overflow:auto !important;height:auto !important;max-height:15rem}
#myModalEditProductSets .select2-container::after{display:none;}
#myModalEditProductSets .select2-container--default.select2-container--open::after{content:"\25b4"}
#myModalEditProductSets .select2-container.overflow::after{right:1.5rem}
#myModalEditProductSets .select2-container--default.select2-container--open .select2-selection--multiple{border-color:#79bde4}
#myModalEditProductSets .select2-selection__choice{background-color:#79bde4;border-color:#79bde4;color:white;line-height:2rem}
#myModalEditProductSets .select2-container--default .select2-selection--multiple .select2-selection__choice__remove{color:white;border-right:1px solid rgba(255,255,255,0.3)}
#myModalEditProductSets .select2-container--default .select2-selection--multiple .select2-selection__choice__remove:hover{background-color:#41a0d8}
#myModalEditProductSets .select2-container--default .select2-search--inline .select2-search__field::placeholder{font-family:"Source Sans Pro", "Helvetica Neue", Helvetica, Arial, sans-serif;color:#bbb}
#myModalEditProductSets .select2-selection__clear{display:none !important;}
#myModalEditProductSets li.select2-search.select2-search--inline {display:none}

.nodes-item-core-box .box-bottom .btn-nodeop:disabled{opacity:0.3}

.tooltip{overflow: hidden;max-width: 3000px;}
</style>

<div id="myModalNodes" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true"></div>
<!-- modal product sets edit -->
<div id="myModalEditProductSets" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content modal-edit-tags">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">Ã—</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="myModalLabel">Edit</h4>
            </div>
            <form id="frmEditProductSet" class="form-horizontal" role="form">
                <div class="modal-body">
                    <section>
						<div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label for="formLabel" class="col-sm-2 col-md-2 control-label">Label </label>
                                     <div class="col-sm-10 col-md-10">
                                        <input type="text" id="formLabel" name="label" class="form-control" value="">
                                    </div>
                                </div>
                            </div>
                        </div>
						<div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label for="formDescription" class="col-sm-2 col-md-2 control-label">Description </label>
                                    <div class="col-sm-10 col-md-10">
                                        <input type="text" id="formDescription" name="description" class="form-control" value="">
                                    </div>
                                </div>
                            </div>
                        </div>
						<div class="row">
							<div class="col-md-12">
								<div class="form-group">
									<label for="sensor" class="col-sm-2 col-md-2 control-label">Sensor </label>
									<div class="col-sm-10 col-md-10">
										<input type="text" id="sensor" name="sensor" class="form-control" value="">
									</div>
								</div>
							</div>
						</div>
                         <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label for="formTags" class="col-sm-2 col-md-2 control-label">Tags </label>
                                    <div class="col-sm-10 col-md-10">
                                        <input id="formTags" name="tags" class="form-control" value="" style="display: none;">
                                    </div>
                                </div>
                            </div>
                        </div>
						 <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label for="formProducts" class="col-sm-2 col-md-2 control-label">Products </label>
									<div class="col-sm-10 col-md-10">
                                       <select id="formProducts" name="produts" multiple="multiple"></select>
                                    </div>
								</div>
							</div>
						</div>
						<div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <div class="col-md-offset-2 col-md-10 col-sm-offset-2 col-sm-10">
                                        <button id="saveProductSet" type="submit" class="btn btn-primary btn-action" name="btnSave">Save</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </form>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div><!-- /.modal-content -->
    </div>
</div>
<!-- Content Header (Page header) -->
<section class="content-header tao-async-ph" style="display:none">
    <h1>Saved product sets / queries<small>Here you can find the list of saved product sets and parameterized queries that can be used as workflow inputs.</small></h1>
    <ol class="breadcrumb">
        <li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
        <li class="active">Queries</li>
    </ol>
</section><!-- /Content Header (Page header) -->
<!-- Main content -->
<section class="content" style="display:none">
	<div id="panel-topo-wrapper" class="row">
		<div class="col-md-12">
			<!-- Custom Tabs -->
			<div class="nav-tabs-custom">
				<ul class="nav nav-tabs hidden-xs">
					<li class="role role-admin active"><a href="#panel-nodes" data-toggle="tab" data-action="all_productSets" aria-expanded="true">Product Sets</a></li>
					<li class="role role-admin"><a href="#panel-nodes" data-toggle="tab" data-action="all_queries" aria-expanded="false">Queries</a></li>
				</ul>
				<div class="tab-content">
					<div class="tab-pane active" id="panel-nodes">
						<div class="row">
							<div class="col-md-12" id="list-master-controls">
								<div class="box-tools pull-left">
									<button class="btn btn-master-tool text-black" data-action="op-plus" data-toggle="tooltip" data-original-title="Add query"><i class="fa fa-plus"></i></button>
								</div>
                                <div class="box-tools pull-left">
                                    <button class="btn btn-master-tool text-black" data-action="op-filter" data-toggle="tooltip" data-original-title="Filter by tags"><i class="fa fa-filter"></i><span class="label label-warning val-count-filters" style="display:none;">0</span></button>
                                </div>
								<div class="box-tools pull-left">
									<form class="search-container" action="">
										<input id="search-box" type="text" class="search-box" name="q" placeholder="Search by name" />
										<label for="search-box"><i class="fa fa-search search-icon" aria-hidden="true"></i></label>
										<input type="submit" id="search-submit" />
									</form>
								</div>
								<div class="box-tools pull-right">
                                    <button class="btn btn-master-tool text-black" data-action="refresh-list" data-toggle="tooltip" data-original-title="Refresh"><i class="fa fa-refresh fa-spin-hover"></i></button>
									<button class="btn btn-master-tool text-black" data-action="view-list" data-toggle="tooltip" data-original-title="List view"><i class="fa fa-list"></i></button>
									<button class="btn btn-master-tool text-black" data-action="view-table" data-toggle="tooltip" data-original-title="Table view"><i class="fa fa-table"></i></button>
								</div>
							</div>
						</div>
                        <div class="row">
                            <div class="col-md-12 like collapse">
                                <span data-tag="tag">Label like: <strong class="val-q"></strong>&nbsp;<i class="fa fa-times fa-fw clear-search" aria-hidden="true"></i></span>
                            </div>
                            <div class="col-md-12 tags collapse">
                                <span class="collapse" data-tag="tag">tag<i class="fa fa-check fa-fw" aria-hidden="true"></i></span>
                            </div>
                        </div>
						<div class="row">
							<div class="col-sm-12">
								<div class="box box-success">
									<div class="box-header">
										<i class="fa fa-cubes"></i>
										<h3 class="box-title">Product Sets -  <span class="val-itemfrom">0</span> to <span class="val-itemto">0</span> of <span class="val-itemscount">0</span></h3>
										<div class="box-tools pull-right nppaginatedcells-order collapse" data-toggle="tooltip" title="Change order"></div>
									</div>
									<div class="nppaginatedcells-empty callout callout-empty">
										<p>List is empty. <span class="results-empty">You do not have any product sets.</span><span class="filter-results-empty collapse">Your current selection did not return any result.</span></p>
									</div>
									<div class="box-body chat users-box" id="nodes-box">
										<div class="nppaginatedcells-panel-body">
										</div>
										<div class="cell-templates collapse">
											<core-cell-grid id="node-master-template" class="collapse core-cell-box">
												<div class="col-md-3 col-sm-6">
													<div class="nodes-item-core-box">
														<div class="box-top-tags"></div>
														<div class="box-top" style="min-height:120px;border-bottom:4px double rgba(0, 100, 160, 0.1)">
															<div class="box-title"><span class="val-_dsLabel"></span></div>
															<div class="box-subtitle"><span class="val-_dsSubtitle"></span></div>
															<div class="box-text" style="height:48px"><span class="val-_dsContents"></span></div>
															<div class="box-icon"><i class="fa fa-cube"></i></div>
														</div>
														<div class="box-bottom with-line">
															<div class="pocket">
																<button type="button" class="btn btn-primary btn-sm btn-flat btn-action btn-nodeop btn-edit" data-action="edit" data-toggle="tooltip" data-original-title="Edit"><i class="fa fa-pencil fa-fw" aria-hidden="true"></i><span class="span-muted collapse">&nbsp;Edit</span></button>
																<button type="button" class="btn btn-primary btn-sm btn-flat btn-action btn-nodeop" data-action="delete" data-toggle="tooltip" data-original-title="Delete"><i class="fa fa-trash-o fa-fw" aria-hidden="true"></i><span class="span-muted collapse">&nbsp;Delete</span></button>
															</div>
														</div>
													</div>
												</div>
											</core-cell-grid>
											<core-cell-list id="node-master-template-list" class="collapse core-cell-box">
												<div class="col-md-12 col-sm-12">
													<div class="nodes-item-core-box">
														<div class="box-top-tags"></div>
														<div class="box-top">
															<div class="box-title"><span class="val-_dsLabel"></span></div>
															<div class="box-subtitle"><span class="val-_dsSubtitle"></span></div>
															<div class="box-text"><span class="val-_dsContents"></span></div>
															<div class="box-icon"><i class="fa fa-cube"></i></div>
														</div>
														<div class="row">
															<div class="col-sm-12 col-xs-12">
																<div class="text-right">
																	<button type="button" class="btn btn-primary btn-sm btn-flat btn-action btn-nodeop" data-action="edit"><i class="fa fa-pencil fa-fw" aria-hidden="true"></i><span class="span-muted">&nbsp;Edit</span></button>
																	<button type="button" class="btn btn-primary btn-sm btn-flat btn-action btn-nodeop" data-action="delete"><i class="fa fa-trash-o fa-fw" aria-hidden="true"></i><span class="span-muted">&nbsp;Delete</span></button>
																</div>
															</div>
														</div>
													</div>
												</div>
											</core-cell-list>
										</div>
									</div>
									<div class="box-footer clearfix no-border">
										<div class="box-tools pull-right"><ul class="nppaginatedcells-panel-pagination pagination pagination-sm inline"></ul></div>
										<div class="box-notification"><p><span>List updated</span></p></div>
									</div>
								</div>
							</div>
						</div>
					</div><!-- /.tab-pane -->
				</div><!-- /.tab-content -->
			</div><!-- /.nav-tabs-custom -->
		</div>
	</div>
</section><!-- /.content -->

<link rel="stylesheet" href="./assets/libs/jQuery-datepicker/jquery-ui.theme.css" type="text/css" />
<link rel="stylesheet" href="./assets/libs/jQuery-datepicker/jquery-ui.structure.css" type="text/css" />
<link rel="stylesheet" href="./assets/libs/jQuery-datepicker/jquery-ui.css" type="text/css" />
<link rel="stylesheet" href="./assets/libs/jQuery-tags-input-autocomplete/jquery.tagsinput-revisited.css" type="text/css" />
<link rel="stylesheet" type="text/css" href="assets/libs/select2/4.1.0/select2.min.css" />

<script src="./assets/libs/jQuery-datepicker/jquery-ui.js" type="text/javascript"></script>
<script src="./assets/libs/jQuery/paginathing.js" type="text/javascript"></script>
<script src="./assets/libs/jQuery-tags-input-autocomplete/jquery.tagsinput-revisited.js" type="text/javascript"></script>
<script type="text/javascript" src="assets/libs/select2/4.1.0/select2.min.js"></script>

<script type="text/javascript" src="./assets/libs/openlayers/ol-poly.js"></script>

<script type="text/javascript">
	
	function myModalNodesOpShow(action, dna) {
		var isCollection = action.indexOf("collection") >= 0 || (dna && dna.tags[0] === "collection");
		var isProducSet = dna && dna.tags[0] === "productSet";
		$("#formProducts option", "#myModalEditProductSets").remove();
		// Open add/edit page
		if (action.indexOf("plus") >= 0 || (dna && dna.tags[0] !== "productSet" && action === "edit")) {
			$.ajax({
				url: "./fragments/datasource-queries-plus.fragment.html?" + Math.random(),
				async: false,
				success: function(result) {
					if (result !== "") {
						// Prepare data
						var oAction = (action === "edit") ? "edit" : "add";
						var oDna = $.extend(true, {}, dna);
						// Remove all extra custom fields added in data preprocessing stage (tags, ds...)
						delete oDna["tags"];
						$.each(Object.keys(oDna), function (index, key) {
							if (key.indexOf("_ds") >= 0) delete oDna[key];
						});
						// Modal stuff
						var $modal = $("#myModalNodes");
						$modal.data({ isCollection: isCollection, action: oAction, dna: oDna });
						$modal.html(result);
						$modal.modal({ backdrop: false, keyboard: false });
						$modal.off('hidden.bs.modal');
						$modal.on('hidden.bs.modal', function () {
							$(this).html("");
							// Refresh data
							panelComp.refreshData();
						});
						$modal.closest(".content-wrapper").addClass("content-wrapper-edit-query");
						$modal.modal("show");
					}
				},
				error: function (jqXHR, textStatus, errorThrown) {
					alert("Could not open the add/edit page. An error occurred while retrieving data from server.");
				}
			});
		// Remove query/collection
		} else if (dna && dna.tags[0] === "productSet" && action === "edit") {
			$.ajax({
				url: baseRestApiURL + "datasource/productset/" + dna.id,
				async: false,
				headers : {
					"X-Auth-Token": window.tokenKey
				},
				success: function(result) {
					if (result.status === "SUCCEEDED") {
						var oDna = result.data;
						var $modal = $("#myModalEditProductSets");
						$modal.data({dna: oDna });
						$modal.modal({ backdrop: false, keyboard: false });
						if(oDna.hasOwnProperty("tags") && oDna["tags"] != null){
							$('#formTags').importTags( oDna['tags'].join());
						}
						if(oDna.hasOwnProperty("label") && oDna["label"] != null){
							$("#formLabel").val(oDna.label);
						}
						if(oDna.hasOwnProperty("description") && oDna["description"] != null){
							$("#formDescription").val(oDna.description);
						}
						if(oDna.hasOwnProperty("type") && oDna["type"] != null){
							$("#sensor").val(oDna.type);
						}
						if (oDna.hasOwnProperty("products") && oDna["products"] != null) {
							$.each(oDna.products, function (index, value) {
								var tmpProductName = (value.length === value.lastIndexOf("/") + 1 ? value.substr(0,value.lastIndexOf("/")) : value); //used to remove the "/" character from the end of product name
								/*$("#formProducts").append("<option value='" + value.replaceAll(" ", "%20") + "' selected='selected'>" + tmpProductName.substr(tmpProductName.lastIndexOf("/") + 1) + "</option>");*/
								$("#formProducts").append("<option value='" + value.replaceAll(" ", "%20") + "' selected='selected'>" + value + "</option>");
							});
						}
						 $modal.modal('show');
					}
				},
				error: function (jqXHR, textStatus, errorThrown) {
					alert("Could not open the add/edit page. An error occurred while retrieving data from server.");
				}
			});
		} else if (action === "delete") {
			if (typeof dna.id === "undefined") {
				showMsg("Unable to perform requested action. Please try again later.", "ERROR");
			} else {
				var deleteUrl = isCollection ? (baseRestApiURL+"datasource/user/group/remove?groupId="+dna.id) : (isProducSet ? (baseRestApiURL+"datasource/productset/"+dna.id) : (baseRestApiURL+"datasource/query/"+dna.id+"/"));
				$('#confirm-dialog').modal("confirm", {
					msg: "Are you sure you want to delete this element: " + dna.label + "?",
					callbackConfirm: function () {
						$.ajax({
							cache   : false,
							url     : deleteUrl,
							dataType: 'json',
							type    : 'DELETE',
							headers : {
								"Accept": "application/json",
								"Content-Type": "application/json",
								"X-Auth-Token": window.tokenKey
							},
							error: function (jqXHR, textStatus, errorThrown) {
								if(jqXHR.status === 500 ) {
									showMsg("Unable to perform requested action. Please try again later.", "ERROR");
								} else {
									alert('An error has occurred, please try again or contact app admin.');
								}
							},
							success: function (data) {
								if(data.status === "FAILED") { 
									showMsg("Failed to delete the product set.", "FAILED");
								} else {
									showMsg("Object successfully deleted.", "SUCCESS");
									panelComp.refreshData();
								}
							}
						});
					},
					callbackCancel : function () {}
				});
			}
		}
	};
	
	$(document).ready(function() {
		var urls = [];
		
		$('a[data-toggle="tab"]', '#panel-topo-wrapper').on('shown.bs.tab', function (e) {
			//clear previous added classes and kill all datepicker controls when parent window is closed
			$('#panel-nodes').closest(".content-wrapper").removeClass("content-wrapper-edit-query");
			$("#" + $.datepicker.dpDiv.attr("id")).remove();
			
            var action = $(this).data("action");
			var title = "";
			if (action === "all_productSets") {
				title = "Product Sets -  ";
				$("button[data-action='op-plus']").hide();
				urls = [
					baseRestApiURL + "datasource/productset"
				]
			}
			if (action === "all_queries") {
			title = "Queries - ";
				$("button[data-action='op-plus']").show();
				urls = [
					baseRestApiURL + "datasource/user/group/",
					baseRestApiURL + "datasource/query/"
				]
			}

			// add new tab title
			$(".box-success .box-header .box-title", "#panel-topo-wrapper").get(0).childNodes[0].nodeValue = title;
			
            window.panelComp.refreshData(urls);
        });
		
		$("#formProducts" ).select2({ placeholder: "Select wanted products..."  , width: "100%", allowClear: true});
		
		window.panelComp = $('#panel-nodes').npPaginatedCells({
			headerUser : taoUserProfile.username,
			url        : urls,
			viewMode   : prefferences.viewMode,
			itemsOnPage: 12,
			order      :[
							{ "label": "Name ascending" , "objAttributeName": "_dsOrderBy", "direction": "ASC", "default": true },
							{ "label": "Name descending", "objAttributeName": "_dsOrderBy", "direction": "DSC" },
							{ "label": "Date ascending" , "objAttributeName": "modified", "direction": "ASC" },
							{ "label": "Date descending", "objAttributeName": "modified", "direction": "DSC" }
						],
			filterAttribute: "_dsFilterBy",
			doDataPreprocessing: function (data) {
				var trimmed = [];
				$.each(data, function (index, item) {
					var isCollection   = typeof item.dataSourceComponents !== "undefined";
					var isInCollection = typeof item.groupId === "string";
					var isProducSet = typeof item.siteId === "undefined" && typeof item.products !== "undefined";
					
					var subComponents = "";
					$.each(item.dataSourceComponents, function (idx, cmp) {
						subComponents += (subComponents == "" ? "" : "<br/>") + "#" + (idx + 1) + ". " + cmp.label + " - " + cmp.sensorName;
					});
					
					// Get time interval for different components
					var interval = "";
					if (typeof item.values !== "undefined") {
						if (typeof item.values.acquisition_date !== "undefined") {
							interval = item.values.acquisition_date;
						} else if (typeof item.values.startDate !== "undefined") {
							interval = item.values.startDate;
						} else if (typeof item.values.beginPosition !== "undefined" && typeof item.values.endPosition !== "undefined") {
							interval = "[" + item.values.beginPosition + "," + item.values.endPosition + "]";
						}
					}
					
					// Add extra custom fields
					/*if (typeof item.tags !== "undefined") {
						item.tags	 = isCollection ? ["collection"] : (isInCollection ? ["component"] : (isProducSet ? ["productSet"] : ["query"])).concat(item.tags);
					} else {*/
						item.tags    = isCollection ? ["collection"] : (isInCollection ? ["component"] : (isProducSet ? ["productSet"] : ["query"]));
					//}
					item._dsLabel    = isCollection ? "[" + item.label  + "]" : (isInCollection ? "[" + item.groupLabel  + "]" : (isProducSet ? item.label : item.sensor + " - " + item.dataSource));
					item._dsSubtitle = isCollection ? "List of queries:" : (isProducSet ? item.description : item.label);
					if (isProducSet) {
						var productTypes = $.unique(item.products.map(
												function(elem) { 
													if (elem.indexOf(".") > -1 ) {
														return elem.substr(elem.toLowerCase().lastIndexOf(".") + 1).replaceAll("/","").toUpperCase();
													}
												})
											);
						item._dsContents = "Products: " + item.products.length + "<br/>" + "Products types: " + (typeof item.type !== "undefined" ? item.type : productTypes.filter(a => typeof a !== "undefined").length > 0 ? productTypes.join(",") : "Mixed");
					} else {
						item._dsContents = isCollection ? subComponents : ("Datasource: " + item.dataSource + "<br/>" + "Sensor: " + item.sensor + "<br/>" + (isInCollection ? "Date: " : "Acquisition interval: ") + interval);
					}
					item._dsOrderBy  = isCollection ? item._dsLabel : ((isInCollection ? item._dsLabel : "") + item.label);
					item._dsFilterBy = (item._dsLabel + item._dsContents).replace(/(<br\/>)|(\[)|(\])|( - )|(\d\. )/g, "").replace(" - ", "");
					
					// Save element
					if (isInCollection) {
						trimmed.push(item);
					} else {
						trimmed.push(item);
					}
				});
				return trimmed;
			},
			doAction: function(action, args){
				myModalNodesOpShow(action, (typeof args === "undefined") ? args : args.dna);
			},
			doCustomRender: function($elClone, elX){
				var title = $(".val-_dsSubtitle", $elClone).html();
				if (elX.dataSource === "Local Database") {
					$elClone.find(".btn-edit").prop("disabled",true);
				}
				if (elX.tags[0] === "collection") {
					$elClone.addClass("query-group");
					$(".fa-cube", $elClone).removeClass("fa-cube").addClass("fa-cubes");
					title = $(".val-_dsLabel", $elClone).html();
				} else if (elX.tags[0] === "component" ) {
					$elClone.addClass("query-component");
					$("button[data-action='delete']", $elClone).prop({ disabled: true });
					title = $(".val-_dsLabel", $elClone).html() + "\n" + title;
				}
			}
		});
		
		$("#frmEditProductSet").on("submit", function(e){
            e.preventDefault(e);
			var dna = $("#myModalEditProductSets").data("dna");
			var formData = {
				id          : dna.id,
				label       : $("#formLabel", this).val(),
				description : $("#formDescription", this).val(),
				type        : $("#sensor", this).val(),
				products    : $("#formProducts", this).select2("val"),
			    tags        : []
			};
			var tags = $("#formTags", this).val();
            formData.tags = tags.split(",");
			
			$.ajax({
				url: baseRestApiURL + "datasource/productset",
				cache: false,
				data: JSON.stringify(formData),
				type: "PUT",
				headers : {
					"Accept": "application/json",
                    "Content-Type": "application/json",
					"X-Auth-Token": window.tokenKey
				},
				success: function(result) {
					if (result.status === "SUCCEEDED") {
						showMsg("Product set successfully saved.", "SUCCESS");
						$("#myModalEditProductSets").modal('hide');
						window.panelComp.refreshData();
					} else {
						showMsg("Error updating product set.", "ERROR");
					}
				},
				error: function (jqXHR, textStatus, errorThrown) {
					showMsg("Error updating product set. " + errorThrown +". ", "ERROR");
				}
			});
		});
		
		if (decodeURI(window.location.hash).indexOf("/explorer") >= 0) {
			$(".btn-master-tool[data-action='op-plus']").trigger("click");
		} else {
			$("a[data-toggle='tab'][data-action='all_productSets']", "#panel-topo-wrapper").trigger("shown.bs.tab");
			$("section.content-header.tao-async-ph").removeAttr("style");
			$("section.content").removeAttr("style");
		}
		
		initializeTagsInputAutocomplete("#formTags", "datasource");
	});
//# sourceURL=datasources-queries.js
</script>