<!-- Content Header (Page header) -->
<section class="content-header tao-async-ph">
    <h1>My Files<small>Full list of user <strong>Files</strong>.</small></h1>
    <ol class="breadcrumb">
        <li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
        <li class="active">My Files</li>
    </ol>
</section>
<!-- /Content Header (Page header) -->
<!-- Main content -->
<section id="tree-content" class="content">
    <div class="row">
        <div class="col-md-12">
			<div class="box">
				<div class="box-header empty"></div>
				<div class="box-body">
					<div class="col-md-12 col-sm-12">
						<div id="toolbox-browser" class="toolbox">
							<div id="components" class="treeview"></div>
							<div id="properties" class="hidden">
								<div id="rm-previewattributes" class="row">
									<div class="col-xs-12">
										<div class="callout box-shadow--6dp">
											<h4 id="file-name">File name</h4>
											<table id="attributes-list" class="table table-hover">
												<thead><tr><th style="width:30%">Name</th><th>Value</th></tr></thead>
												<tbody></tbody>
											</table>
											<div class="imagepreview-holder hidden"><img src="" /></div>
										</div>
									</div>
								</div>
								<div class="row">
									<div class="col-xs-12">
										<div class="callout callout-info lead filedownload-holder">
											<h4>Download! (<span id="file-size">size:</span>)</h4>
											<p>You can access <a id="downloadFile" href="#"><button class="btn bg-green btn-flat"><i class="fa fa-download fa-fw"></i> your file directly</button></a></p>
										</div>
									</div>
								</div>
								<div class="row hidden">
									<div class="col-xs-12">
										<div class="callout callout-info lead filedelete-holder">
											<h4>Delete!</h4>
											<p>You can <a id="deleteFile" href="#"><button class="btn bg-green btn-flat"><i class="fa fa-trash fa-fw"></i> delete your file</button></a></p>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
			   </div>
				<div class="box-header empty"></div>
			</div>
        </div>
    </div>
</section>

<style>
.toolbox {
	display: table;
	width:100%;
}
.toolbox>div {
	display: table-cell;
	vertical-align: top;
}
.toolbox>div:last-child {
	width: 47%;
	padding: 0 1% 0 2%;
}
.toolbox .treeview input[type="checkbox"] {
	display: none;
}
.toolbox .treeview label, .toolbox .treeview a {
	display: block;
	position: relative;
	padding: 5px 0 5px 25px;
	line-height: 1.1em;
	cursor: pointer;
	margin-bottom: 0;
}
.toolbox .treeview label {
	color: #5c5d5e;
}
.toolbox .treeview a {
	width: 100%;
	padding-left: 0;
}
.toolbox .treeview a:hover, .toolbox .treeview a:focus {
	background-color: #ecf0f5;
}
.toolbox .treeview a span {
	float: right;
	padding: 0 20px 0 0;
	width: 110px;
	text-align: right;
	color: #5c5d5e;
}
.toolbox .treeview a span.fa {
	float: none;
	padding: 0 7px;
	width: auto;
	color: #3c8dbc;
}
.toolbox .treeview label::before, .toolbox .treeview  a::before {
	display: block;
	position: absolute;
	top: 6px;
	left: 5px;
	font-family: 'FontAwesome';
	color: #3c8dbc;
}
.toolbox .treeview label::before {
	content: '\f07b'; /* closed folder */
}
.toolbox .treeview input:checked+label::before {
	content: '\f07c'; /* open folder */
}
.toolbox .treeview .sub {
	display: none;
	margin-left: 20px;
}
.toolbox .treeview input:checked ~ .sub {
	display: block;
}
#properties{
	position: fixed;
	right: 1%;
	margin-top: 30px;
	top: 0;
}
#properties .box-header {
	overflow-x: hidden;
}
#properties .callout {
	padding-right: 20px;
	border-color: #3c8dbc;
	background-color: white;
}
#properties #file-name {
    margin-top: -15px;
    margin-left: -15px;
    margin-right: -20px;
    background-color: #3c8dbc;
    color: white;
    padding: 10px;
    border-top: 15px solid #00c0ef;
}
#properties table {
	margin-bottom: 0;
}
#properties table td {
	padding: 5px 10px;
	line-height: 1.5em;
}
.imagepreview-holder {
	text-align: center;
}
.imagepreview-holder img {
	max-width: 100%;
}

</style>

<script>
var compsTree = $("#components.treeview");

$.ajax({
	url: baseRestApiURL + "files/user/",
	type: "GET",
	dataType: 'json',
	beforeSend: function(xhr) {
		xhr.setRequestHeader("Accept", "application/json");
		xhr.setRequestHeader("Content-Type", "application/json");
		xhr.setRequestHeader("X-Auth-Token", tokenKey);
	},
	error: function (jqXHR, textStatus) {
		alert("Error while loading files.");
		compsTree.closest(".box").addClass("box-warning");
	},
	success: function(response) {
		compsTree.closest(".box").addClass("box-success");
		renderTree(response);
	}
});

function renderTree(response) {
	compsTree.html("");
	
	//$.ajax({ url: "http://localhost:8080/files/?fileName=good_files.json", type: "GET", dataType: 'json', async: false, success: function(data) { response = data; } });
	
	// Render tree folders
	$.each(response, function (index, file) {
		if (file.folder && file.relativePath != "") {
			renderFolder(file.relativePath);
		}
	});
	
	// Render files
	$.each(response, function (index, file) {
		if (!file.folder) {
			var size = parseInt(file.size);
			if (size < 1024) {
				size = size + " B";
			} else if (size < 1024*1024) {
				size = parseFloat(size / 1024, 2).toFixed(2) + " KB";
			} else if (size < 1024*1024*1024) {
				size = parseFloat(size / 1024 / 1024, 2).toFixed(2) + " MB";
			} else if (size < 1024*1024*1024*1024) {
				size = parseFloat(size / 1024 / 1024 / 1024, 2).toFixed(2) + " GB";
			} else {
				size = parseFloat(size / 1024 / 1024 / 1024 / 1024, 2).toFixed(2) + " TB";
			}
			var name   = file.relativePath.substring(file.relativePath.lastIndexOf("\\") + 1);
			var href   = baseRestApiURL + 'files/?fileName=' + file.relativePath.replace("\\", "/");
			var type   = file.relativePath.substring(file.relativePath.lastIndexOf("."));
			var folder = getParentFolder(file.relativePath);
			var fafile = "fa-file-o";
			switch (type) {
				case ".txt" : fafile = "fa-file-text-o"   ; break;
				case ".html": fafile = "fa-file-code-o"   ; break;
				case ".xml" : fafile = "fa-file-code-o"   ; break;
				case ".tif" : fafile = "fa-file-image-o"  ; break;
				case ".png" : fafile = "fa-file-image-o"  ; break;
				case ".pdf" : fafile = "fa-file-pdf-o"    ; break;
				case ".zip" : fafile = "fa-file-archive-o"; break;
			}
			var element = $('<a href="#"><span class="fa ' + fafile + '"></span>' + name + '<span>' + size + '</span>' + '<span>' + type + '</span>' + '</a>');
			
			if (!file.attributes) { file.attributes = {}; }
			file.attributes.fileInfo = {};
			file.attributes.fileInfo.fileSize = size;
			file.attributes.fileInfo.fileName = name;
			file.attributes.fileInfo.fileType = type;
			file.attributes.fileInfo.uri = href;
			
			element.data("attributes", file.attributes);
			folder.append(element);
		}
	});
}

function getParentFolder(relativePath) {
	var parentId = relativePath.substring(0, relativePath.lastIndexOf("\\"));
	var parent = $("input[id='" + parentId.replace("\\", "\\\\") + "']").parent().find(">.sub");
	if (parent.length == 0) { parent = compsTree; }
	return parent;
}

function renderFolder(relativePath) {
	// get parent, render if null
	var parent = getParentFolder(relativePath);
	if (parent == compsTree && relativePath.indexOf("\\") >= 0 ) {
		renderFolder(relativePath.substring(0, relativePath.lastIndexOf("\\")));
	}
	
	var folder = parent.find("#" + relativePath);
	// render folder if null
	if (folder.length == 0) {
		var id = relativePath;
		var str = '<div><input type="checkbox" id="' + id + '"><label for="'  + id +  '">' + relativePath.substring(relativePath.lastIndexOf("\\") + 1) + '</label><div class="sub"></div></div>';
		parent.append($(str));
	}
}

function setPreviewImageBase64(attributes) {
	if ($("#properties .imagepreview-holder img").attr("src") != "") {
		$("#properties .imagepreview-holder").toggleClass("hidden");
	} else {
		$("#properties .imagepreview-holder").addClass("hidden");
		$("#properties .imagepreview-holder img").attr("src", "");
		if (attributes.formatType == "RASTER") {
			$.ajax({
				url: attributes.fileInfo.uri.replace("?fileName=", "preview?fileName="),
				type: "GET",
				beforeSend: function(xhr) { xhr.setRequestHeader("X-Auth-Token", tokenKey); },
				success: function(response) {
					$("#properties .imagepreview-holder img").attr("src", response == "" ? "" : "data:image/jpeg;base64, " + response);
					$("#properties .imagepreview-holder").removeClass("hidden");
				}
			});
		}
	}
}

function displayPreview(attributes) {
	$("#properties #file-name").text(attributes.fileInfo.fileName);
	var tableBody = $("#properties #rm-previewattributes #attributes-list tbody");
	tableBody.html("");
	
	var size = 0;
	$.each(attributes, function (name, value) {
		if (name == "productType" && value == "GeoTIFF") {
			tableBody.append('<tr><td>' + name + '</td><td>' + value + '<button class="btn bg-green btn-flat btn-xs image-preview" style="float: right"><i class="fa fa-eye fa-fw"></i>Toggle quick view</button></td></tr>');
		} else if (name != "fileInfo") {
			tableBody.append('<tr><td>' + name + '</td><td>' + value + '</td></tr>');
		} else {
			size --;
		}
		size ++;
	});
	if (size == 0) {
		tableBody.append('<tr><td>-</td><td>-</td></tr>');
	}
	
	$("#properties .imagepreview-holder").addClass("hidden");
	$("#properties .imagepreview-holder img").attr("src", "");
	
	$("#properties #file-size").text(attributes.fileInfo.fileSize);
	$("#properties .filedownload-holder a").attr("href", attributes.fileInfo.uri);
	
	$("#properties").removeClass("hidden");
	$("#properties").data("attributes", attributes);
}

// Download file using current user's credentials
$("#toolbox-browser").on("click", function (e) {
	if (e.target.id == "toolbox-browser") {
		$("#properties").addClass("hidden");
	}
});

$("#components").on("click", "a", function (e) {
	e.preventDefault();
	adjustPropertiesPosition();
	displayPreview($(this).data("attributes"));
});

$("#properties").on("click", "button.image-preview", function (e) {
	var attributes = $(this).closest("#properties").data("attributes");
	setPreviewImageBase64(attributes);
});

$("#properties .filedownload-holder").on("click", "a", function (e) {
	e.preventDefault();
	
	var attributes = $(this).closest("#properties").data("attributes");
	var filename   = attributes.fileInfo.fileName;
	
	var xhr = new XMLHttpRequest();
	xhr.open('GET', this.href, true);
	xhr.setRequestHeader("Authorization", authHeader);
	xhr.responseType = 'blob';
	xhr.onload = function(e) {
		if (this.status == 200) {
	        var blob = new Blob([this.response], { type: this.getResponseHeader('Content-Type') });
			
	        if (typeof window.navigator.msSaveBlob !== 'undefined') {
	            // IE workaround for "HTML7007: One or more blob URLs were revoked by closing the blob for which they were created.
				// These URLs will no longer resolve as the data backing the URL has been freed."
	            window.navigator.msSaveBlob(blob, filename);
	        } else {
	            var URL = window.URL || window.webkitURL;
	            var downloadUrl = URL.createObjectURL(blob);
				
				// use HTML5 a[download] attribute to specify filename
				var a = document.createElement("a");
				// safari doesn't support this yet
				if (typeof a.download === 'undefined') {
					window.location = downloadUrl;
				} else {
					a.href = downloadUrl;
					a.download = filename;
					document.body.appendChild(a);
					a.click();
				}
	            setTimeout( function () { URL.revokeObjectURL(downloadUrl); $(a).remove(); }, 100 ); // cleanup
	        }
		}
	}
	xhr.send();
});

$("#properties .filedelete-holder").on("click", "a", function (e) {
	e.preventDefault();
	return false;
});

function adjustPropertiesPosition() {
	var scrollTop  = document.documentElement ? document.documentElement.scrollTop : document.body.scrollTop;
	var treeTop    = $("#tree-content>.row").offset().top;
	var contentTop = $("#tree-content>.row").offset().top;
	$("#properties").css({ top: scrollTop >= treeTop ? "" : (contentTop -  scrollTop) + "px" });
}
$(document).on("ready scroll resize", function() {
	adjustPropertiesPosition();
});

//# sourceURL=my-auxfiles.js
</script>

<!-- /Main content -->
