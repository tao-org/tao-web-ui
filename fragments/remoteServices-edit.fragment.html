<style>
.modal-error{background-color:red}
.modal-error span{background:#a63f3f}
.floating-img{width:16.666667%;float:right}
.tbl-edt{border-top:0;margin:0}
.tbl-edt thead tr:nth-child(1) th{position:sticky;background:#556270;color:white;top:0px;z-index:10;white-space:normal;word-break:break-all;vertical-align:middle;padding:3px 8px}
.tbl-edt tbody tr:nth-child(even){background-color:#f4f4f4}
.tbl-edt tbody tr td{padding:3px 8px}
.icon{text-align: center;}
.new-icon{color: rgb(255 98 5 / 87%);
    font-family: 'Source Sans Pro','Helvetica Neue',Helvetica,Arial,sans-serif;
    font-size: 14px;
    font-weight: bold;}
#frmEditContainer img.base64image.empty::before{position:relative}
#frmEditContainer img.base64image.empty::after{position:relative}
form .tagsinput .tag{background-color:#f4f4f4;border:1px solid #dedede;color:#556270}
@media (max-width: 991px) {
	.floating-img{width:100%;margin-bottom:10px}
}
@media (min-width: 992px) {
	 .col-name .col-md-2{width:20%}
	 .col-name .col-md-10{width:80%}
}
.loading{z-index: 1;position: absolute;bottom: 200px;text-align: center;}
</style>
<div class="modal-content">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title" id="myModalLabel">Edit remote service</h4>
    </div>
	
    <form id="frmEditContainer" class="form-horizontal" action="" role="form">
		<input type="hidden" name="system" value="true" />
        <div class="modal-error collapse">
            <h4 class="modal-title">Error updating remote service!</h4>
            <p id="modal-error-msg">Please check your data.</p>
            <p>
                <span class="error-container collapse"><i class="fa fa-exclamation-triangle fa-fw"></i>Error.</span>
            </p>
        </div>
        <div class="modal-body">
            <section>

				<div class="row form-group">
					<label class="col-sm-2 col-md-2 control-label" style="font-size: medium;">Authentication</label>
					<div class="col-md-12 form-group" >
						<form class="form-check form-check-inline  form-group">
							<div class="form-inline col-md-12">
								<div class="row">
									<div class="form-group form-inline col-sm-6 col-md-6">
										<label class="col-sm-4 col-md-4 control-label" >Type</label>

										<label class="radio-inline">
											<input type="radio" name="authOpt" id="noneAuth" value="NONE" checked>None
										</label>

										<label class="radio-inline">
											<input type="radio" name="authOpt" id="basicAuth" value="BASIC">Basic
										</label>
						
										<label class="radio-inline">
											<input type="radio" name="authOpt" id="tokenAuth" value="TOKEN">Token
										</label>

									</div>
									<div class="form-inline form-group col-sm-6 col-md-6">
										<label for="authHd" class="col-sm-5 col-md-5 control-label">Header</label>
										<input type="text" class="form-control" id="authHd" name="authHd" placeholder="Header" autocomplete="off" value="" readonly/>
										
									</div>
								</div>
							</div>
							
						</form>

					</div>
					<div class="col-md-12"></div>
					<div class="col-md-12">
						<div class="form-group">
							<label for="uname" class="col-sm-2 col-md-2 control-label" >Username</label>
							<div class="col-sm-10 col-md-10">
    							<input type="text" class="form-control" placeholder="Enter Username" id="uname" name="uname" readonly>
							</div>
						</div>
					</div>

					<div class="col-md-12">
						<div class="form-group">
							<label for="psw" class="col-sm-2 col-md-2 control-label" >Password</label>
							<div class="col-sm-10 col-md-10">
								<input type="password" class="form-control" placeholder="Enter Password" id="psw" name="psw" readonly>
							</div>
						</div>
					</div>

					<div class="col-md-12">
						<div class="form-group">
							<label for="loginURL" class="col-sm-2 col-md-2 control-label" >Login URL</label>
							<div class="col-sm-10 col-md-10">
								<input type="text" class="form-control" id="loginURL" name="loginURL" placeholder="Login URL" autocomplete="off" value="" readonly />
							</div>
						</div>
					</div>
				</div>
				
				<div class="row">
                    <div class=" col-md-12">
                        <div class="form-group">
                            <label for="name" class="col-sm-2 col-md-2 control-label">Name</label>
                            <div class="col-sm-10 col-md-10">
                                <input type="text" class="form-control" id="name" name="name" placeholder="name" value="" autocomplete="off" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="description" class="col-sm-2 col-md-2 control-label">Description</label>
                            <div class="col-sm-10 col-md-10">
                                <textarea class="form-control" rows="1" id="description" name="description" placeholder="description" style="resize:none"></textarea>
                            </div>
                        </div>
					</div>
					
                </div>

				<div class="row">
					<div class="col-md-2 floating-img">
						<div class="col-md-10 col-sm-10 col-md-2">
							<button id="inspect" type="button" class="btn btn-primary btn-submit" name="btnInspect">Inspect</button>
						</div>
					</div>
                    <div class="col-md-10 col-name">
                        <div class="form-group">
                            <label for="applicationPath" class="col-sm-2 col-md-2 control-label">Application path</label>
                            <div class="col-sm-10 col-md-10">
                                <input type="text" class="form-control" id="applicationPath" name="applicationPath" value="" />
                            </div>
                        </div>
					</div>
                </div>

                <div class="row">
					<div class="col-md-12 loading hidden">
						<img src="./assets/dist/img/loading-circle.gif" />
					</div>
                    <div class="col-md-12">
                        <div class="form-group">
                            <label class="col-sm-2 col-md-2 control-label">Applications</label>
                            <div class="col-sm-10 col-md-10" style="overflow:auto;max-height:350px">

								<table class="table table-bordered box-shadow--6dp tbl-edt" id="tbl-applications">
									<thead>
										<tr>
											<th></th>
											<th></th>
											<th>Name</th>
											<th>Path</th>
											<!--<th>Memory<br/>Requirements</th>
											<th>Parralel Flag<br/>Template</th>-->
										</tr>
									</thead>
									<tbody class="tpl-sample-body">
										<tr class="tpl-sample-row">
											<th class="icon"><span class="glyphicon"></span></th>
											<th class="del-col" scope="row">
												<a href="#" class="text tbl-app-delete-action"><i class="fa fa-trash-o fa-fw" aria-hidden="true"></i></a>
											</th>
											<td><input type="text" class="app-name" value="" placeholder="name"></td>
											<td><input type="text" class="app-path" value="" placeholder="path"></td>
											<!--<td><input type="text" class="app-memoryRequirements" value="" placeholder="memory requirements"></td>
											<td><input type="text" class="app-parallelFlagTemplate" value="" placeholder="parallel flag template"></td>-->
										</tr>
										</tbody>
								</table>
								<div class="col-md-12" style="margin-top: 10px; display: none;" id="legend">
									<div class="inline-block inline" style="margin-right: 15px;">
										<span class="glyphicon glyphicon-ok" style="color: #008000de;"></span>
										<span> Available App </span>
									</div>
									<div class="inline-block inline" style="margin-right: 15px;">
										<span class="glyphicon glyphicon-remove" style="color: #d30d0dee;"></span>
										<span> Unavailable App </span>
									</div>
									<div class="inline-block inline ">
										<span class="new-icon">New!</span>
										<span>New App</span>
									</div>
								</div>
								
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group">
                            <div class="col-md-offset-2 col-md-10 col-sm-offset-2 col-sm-10">
                                <button id="saveContainer" type="submit" class="btn btn-primary btn-submit" name="btnSave">Update remote service</button>
                            </div>
                        </div>
                    </div>
                </div>
				<div class="box-notification"><p><span>Inspection finished</span></p></div>
            </section>
        </div><!-- /.modal-body -->
    </form>
    <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
    </div>
</div><!-- /.modal-content -->
<link rel="stylesheet" href="./assets/libs/jQuery-tags-input-autocomplete/jquery.tagsinput-revisited.css" type="text/css" />
<script src="./assets/libs/jQuery-tags-input-autocomplete/jquery.tagsinput-revisited.js" type="text/javascript"></script>

<script>

	$('input[name="authOpt"]').change(function(){
		var authChoice = document.querySelector('input[name="authOpt"]:checked').value;
		if(authChoice == "NONE"){
			document.getElementById("uname").setAttribute('readonly', true);
			document.getElementById("psw").setAttribute('readonly', true);
			document.getElementById("loginURL").setAttribute('readonly', true)
			document.getElementById("authHd").setAttribute('readonly', true);
		}
		else{
			document.getElementById("uname").removeAttribute('readonly');
			document.getElementById("psw").removeAttribute('readonly');
			document.getElementById("loginURL").removeAttribute('readonly');
			
		}

		if(authChoice == "BASIC"){
			document.getElementById("authHd").setAttribute('readonly', true);
		}
		else if(authChoice == "TOKEN"){
			document.getElementById("authHd").removeAttribute('readonly');
		}

    } );

	$('input[name="authOpt"]').change(function(){
		var req = document.querySelector('input[name="authOpt"]:checked').value;
		if(req == "NONE"){
			document.getElementById("uname").removeAttribute('required');
			document.getElementById("psw").removeAttribute('required');
			document.getElementById("loginURL").removeAttribute('required');
			document.getElementById("authHd").removeAttribute('required');
		}
		else{
			document.getElementById("uname").setAttribute('required', true);
			document.getElementById("psw").setAttribute('required', true);
			document.getElementById("loginURL").setAttribute('required', true);
			//document.getElementById("authHd").setAttribute('required', true);
			
		}
		if(req == "BASIC"){
			document.getElementById("authHd").removeAttribute('required');
		}
		else if(req == "TOKEN"){
			document.getElementById("authHd").setAttribute('required', true);
		}
	} );

	function helper_addApplicationRow($tbl, payload){
        var obj = {"name":"","path":""/*,"memoryRequirements":"","parallelFlagTemplate":""*/};
        $.extend( obj, payload );
		
		var $el = $tbl.find(".tpl-sample-body").clone().removeClass("tpl-sample-body");
		$el.find(".tpl-sample-row").addClass("val-row").removeClass("tpl-sample-row");
		
        $('input.app-name', $el).val(obj.name);
		$('input.app-path', $el).val(obj.path);
		//$('input.app-memoryRequirements', $el).val(obj.memoryRequirements);
		//$('input.app-parallelFlagTemplate', $el).val(obj.parallelFlagTemplate);
        $tbl.append($el);
	}

	
	//////////////////////////////////////////////////////////////////////////////////////
    $(document).ready( function() {
		var $form = $("form#frmEditContainer");
		var obj = window.userOpStack.dna;
		var selectedRemoteService = $("a[data-toggle='tab'][aria-expanded='true']", "#panel-remote-wrapper").data("action");
		
		// initializeFormats
		$("#formats", $form).tagsInput({
			minChars    : 0,
			maxChars    : null,
			limit       : null,
			interactive : true,
			autocomplete: null,
			unique      : true,
			placeholder : 'Add a format',
			delimiter   : ','
		});
		
		if (typeof obj !== "undefined") {
			$("input[name=name]", $form).val(obj.name);
			$("textarea[name=description]", $form).val(obj.description);
			$("input[name=uname]", $form).val(obj.user);
			$("input[name=psw]", $form).val(obj.password);
			$("input[name=loginURL]", $form).val(obj.loginUrl);
			$("input[name=authHd]", $form).val(obj.authHeader);
			if (typeof obj.authType !== "undefined") {
				var id = obj.authType.toLowerCase() + "Auth";
				document.getElementById(id).checked = true;
			}
			
		/*	$("#tbl-applications tbody", $form).html("");
			$.each(obj.applications, function (index, app) {
				var tr = '<tr>' +
							'<td>' + app.name + '</td>' +
							'<td>' + app.applicationPath + '</td>' +
							'<td>' + app.memoryRequirements + '</td>' +
							'<td>' + app.parallelFlagTemplate + '</td>' +
						'</tr>';
				$("#tbl-applications tbody", $form).append(tr);
				//$("select#applications", $form).append("<option>" + app.name + "</option>")
			});*/
			
			$.each(obj.applications, function(i, value) {
				helper_addApplicationRow($("#tbl-applications"), value);
			});

			$.each(obj.format, function (index, format) {
				$("#formats", $form).addTag(format);
			});
			
			$("input[name=applicationPath]", $form).val(obj.applicationPath);
			$("input[name=formatNameParameter]", $form).val(obj.formatNameParameter);
			$("input[name=commonParameters]", $form).val(obj.commonParameters);
			$("input[name=tag]", $form).val(obj.tag);
		}

		var authChoice = obj.authType;
		if(typeof authChoice === "undefined" || authChoice === "NONE") {
			document.getElementById("uname").setAttribute('readonly', true);
			document.getElementById("psw").setAttribute('readonly', true);
			document.getElementById("loginURL").setAttribute('readonly', true)
			document.getElementById("authHd").setAttribute('readonly', true);
		} else {
			document.getElementById("uname").removeAttribute('readonly');
			document.getElementById("psw").removeAttribute('readonly');
			document.getElementById("loginURL").removeAttribute('readonly');	
		}
		if(authChoice === "BASIC") {
			document.getElementById("authHd").setAttribute('readonly', true);
		}
		else if(authChoice === "TOKEN") {
			document.getElementById("authHd").removeAttribute('readonly');
		}

		$(".tbl-edt")
            .on("click", ".tbl-app-delete-action", function(e){
                e.preventDefault();
                $(this).closest(".val-row").remove();
			});
		
		
		// Custom validation for container name
		$.validator.addMethod('containerName', function (value, element, params) {
			var pattern = new RegExp(params.regEx, "g");
			var match = value.match(pattern);
			return value.length == 0 || match;
		}, 'Remove invalid characters (only allowed small caps letters, numbers and dashes).');

		$.validator.addMethod( "isUnique", function(value,element,params){
			var isUni = true;
			if($.inArray(value, nameListRS) >= 0 && value !== obj.name ){
				isUni = false;
			}
			return isUni;
		}, "Remote service's name must be unique.");

		// Validate form before submit
		$("form#frmEditContainer").validate({
			rules: {
				name: {
					required: true,
					containerName: { regEx: "^[a-z0-9-]+$" },
					isUnique: true
				},
				description: {
					required: true
				},
			},
			highlight: function(element, errorClass) {
				$(element).parent().addClass("has-error");
			},
			unhighlight: function(element, errorClass) {
				$(element).parent().removeClass("has-error");
			},
			messages: {
			},
			errorPlacement: function(error, element) {
				error.appendTo(element.parent());
			},
			success: function(label) {
				label.remove();
			}
		});
		
        // Submit form
		$("form#frmEditContainer").submit(function (event) {

			event.preventDefault();

			var formData = {
				id                 : userOpStack.dna.id,

				name				: $("input[name=name]", this).val(),
				description			: $("textarea[name=description]", this).val(),
				applicationPath		: $("input[name=applicationPath]", this).val(),
				applications		: [],
				type				: userOpStack.dna.type,
				tag					: userOpStack.dna.tag,
				format				: [],
				authType 			: $("input[name=authOpt]:checked", this).val(),
				user 				: $("input[name=uname]", this).val(),
				password			: $("input[name=psw]", this).val(),
				loginUrl			: $("input[name=loginURL]", this).val(),
				authHeader 			: $("input[name=authHd]", this).val()
			};

			formData.applications = [];
			var haserror=0;
			var applNamesArr=[]; 

            var $tblContApp = $("#tbl-applications");
            //$(".val-row", $tblContApp).each(function() {
			$(".val-row:not(:has(th>span.glyphicon-remove))", $tblContApp).each(function() {
				
				var name = $(this).find("input.app-name").val();
				var path = $(this).find("input.app-path").val();
				//var memoryRequirements = $(this).find("input.app-memoryRequirements").val();
				//var parallelFlagTemplate = $(this).find("input.app-parallelFlagTemplate").val();

				var newApp = {};
			
               if( (typeof name !== "undefined") && (typeof name.valueOf() === "string") && (name.length > 0) && (typeof path !== "undefined") && (typeof path.valueOf() === "string") && (path.length > 0) ) {
                    newApp.name = name;
					newApp.path = path;
					//newApp.memoryRequirements = memoryRequirements;
					//newApp.parallelFlagTemplate = parallelFlagTemplate;

					formData.applications.push(newApp);
					
					applNamesArr.push(name);
                }else{
					haserror = 1;
                }
			});

			var applDuplicates=0;
			if(applNamesArr.length !== new Set(applNamesArr).size) {
				applDuplicates = 1;
			}

			if (haserror==1) {
				showMsg("Invalid application. Please choose valid names and paths to continue.", "ERROR");
			} else if (applDuplicates==1) {
				showMsg("Invalid application. Please choose unique names to continue.", "ERROR");
			} else {
				if ($(this).valid()) {
					$(".modal-error ").fadeOut();
					var url = baseRestApiURL + userOpStack.dna.type.toLowerCase() + "/";
					$.ajax({
						cache: false,
						url: url,
						dataType: 'json',
						type: "PUT",
						data: JSON.stringify(formData),
						headers: {
							"Accept": "application/json",
							"Content-Type": "application/json",
							"X-Auth-Token": window.tokenKey
						},
						error : function (jqXHR, textStatus, errorThrown) {
							if (jqXHR.status === 500) {
								showMsg("Error updating remote service. Please check your data and try again.", "ERROR");
								return;
							}
							showMsg("Unknown error. Unable to update remote service. Please try again.", "ERROR");
						},
						success: function(response,textStatus, jqXHR) {
							var r = chkTSRF(response);
							if (response.status === "FAILED") {
								if (response.message) {
									showMsg("Error updating remote service. Please check your data, one or more values for the attributes were not correct.", "ERROR");
									//handle error messages
									
									var objResponse = JSON.parse(jqXHR.responseText);
									objResponse = objResponse.message.split(';');
									if (objResponse[0] !== "Entity has validation errors") {
										return;
									}
									for (i = 0; i < objResponse.length; i ++) {
										var matches = objResponse[i].match(/\[(.*?)\]/);
										if (matches) {
											$(".error-"+matches[1],".modal-error").css('display', 'inline-block');
										}
									}
									$(".modal-error ").fadeIn("slow");
									$('#myModalNodes').animate({scrollTop: 0}, 250);
									return;
								}
								showMsg("Error updating container. Please check your data and try again.", "ERROR");
							}
							showMsg("Container successfully saved.", "SUCCESS");
							$("#myModalNodes").modal('hide');
							panelComp.refreshData();
						}
					});
				}
			}
            return false; // To avoid actual submission of the form
        });

		$("#inspect").on("click", function(){
			var url = "";
			
			var inspectAuthentication = {
				"type": $('input[name="authOpt"]:checked').val(),
				"user": $('input[name="uname"]').val(),
				"password": $('input[name="psw"]').val(),
				"loginUrl": $('input[name="loginURL"]').val(),
				"authHeader": $('input[name="authHd"]').val()
			}

			var inspectData = {
				"remoteAddress" : $("#applicationPath").val(),
				"authentication" : JSON.stringify(inspectAuthentication)
			}
			if (selectedRemoteService === "wps_nodes") {
				$.extend( inspectData, {"request" : "GetCapabilities"} );
				url = baseRestApiURL + "wps/inspect";
			}
			if (selectedRemoteService === "stac_nodes") {
				url = baseRestApiURL + "stac/collections";
			}
			if (selectedRemoteService === "wms_nodes") {
				$.extend( inspectData, {"request" : "GetCapabilities"} );
				url = baseRestApiURL + "wms/inspect";
			}
			if (url !== "") {
				$(".loading").removeClass("hidden");
				if( $("input.app-path","#tbl-applications tbody:not(.tpl-sample-body)").length <= 3){
					var bottomPos = $("input.app-path","#tbl-applications tbody:not(.tpl-sample-body)").length * 20 + 70 +'px';
					$(".loading").css("bottom", bottomPos);
				}else{
					$(".loading").css("bottom", "200px");
				}
				$("#tbl-applications").css("opacity","0.5");

				$.ajax({
					cache: false,
					url: url,
					type: "POST",
					data: inspectData,
					headers: {
						"Content-Type": "application/x-www-form-urlencoded",
						"X-Auth-Token": window.tokenKey
					},
					error : function (jqXHR, textStatus, errorThrown) {
						$(".loading").addClass("hidden");$("#tbl-applications").css("opacity","");
						showMsg("Unknown error. Unable to inspect remote service. Please try again.", "ERROR");
					},
					success: function(response,textStatus, jqXHR) {
						var r = chkTSRF(response);
						if (response.status === "FAILED") {
							$(".loading").addClass("hidden");$("#tbl-applications").css("opacity","");
							if (response.message) {
								showMsg("Error updating remote service. Please check your data, one or more values for the attributes were not correct.", "ERROR");
								//handle error messages
								
								var objResponse = JSON.parse(jqXHR.responseText);
								objResponse = objResponse.message.split(';');
								if (objResponse[0] !== "Entity has validation errors") {
									return;
								}
								for (i = 0; i < objResponse.length; i ++) {
									var matches = objResponse[i].match(/\[(.*?)\]/);
									if (matches) {
										//$(".error-"+matches[1],".modal-error").show();
										$(".error-"+matches[1],".modal-error").css('display', 'inline-block');
									}
								}
								$(".modal-error ").fadeIn("slow");
								$('#myModalNodes').animate({scrollTop: 0}, 250);
								return;
								
							}
							showMsg("Error updating inspect. Please check your data and try again.", "ERROR");
						}

						if(response.status === "SUCCEEDED"){
							var dataApp = response.data.applications;
							var existingPaths = $("input.app-path","#tbl-applications tbody:not(.tpl-sample-body)").map(function(){return $(this).val();});
								
							// for each entry from response 
							$.each(dataApp, function(index,element){
								var elementId = element.path;
								var existingValue = false;

								// if element is already in table
								if( $.inArray(elementId, existingPaths) > -1){
									existingValue = true;

									$("input.app-path","#tbl-applications tbody:not(.tpl-sample-body)").filter(function(){return this.value == elementId}).closest("tr").find("span:not(.new-icon)").addClass("glyphicon-ok").css({"color":"#008000de"});

								}

								// else and has no path
								if(existingValue === false && (typeof element.path !== 'undefined')){
									//adding new elements in table
									helper_addApplicationRow($("#tbl-applications"), element);
									$("input.app-path","#tbl-applications tbody:not(.tpl-sample-body)").filter(function(){return this.value == elementId}).closest("tr").find("span").text("New!").addClass("new-icon");
								}							
							});

							// for each table row
							$.each(existingPaths, function(i,value){
								var keep = false;

								if(dataApp.some(obj => obj.path === value)){
									keep = true;
								}

								if(keep === false){
									//delete row with non-existing value 
									//$("input.app-path","#tbl-applications tbody:not(.tpl-sample-body)").filter(function(){return this.value == value}).closest("tr").remove();
									$("input.app-path","#tbl-applications tbody:not(.tpl-sample-body)").filter(function(){return this.value == value}).closest("tr").find("span").addClass("glyphicon-remove").css({"color":"#d30d0dee"});
								}

							});
							$("#legend").show();

							$(".loading").addClass("hidden");
							$("#tbl-applications").css("opacity","");
							var $notification = $(".box-notification");
							$notification.addClass("show");
							setTimeout(function(){
								$notification.removeClass("show");
							}, 3000);
						}						
					}
				});
			} else {
				showMsg("Error inspecting remote service.", "ERROR");
				console.error("Wrong action! Inspect can not be done!");
			}

		});

    });

	//# sourceURL=remoteServices-edit.js

</script>