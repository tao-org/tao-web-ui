<style>
	.node-root .nodes-item-core-box .box-top-tags span.status{
		font-weight: 700;
		background-color: #91ff91;
		border-color: #009600;
		color: #555;
	}
	.node-root.offline .nodes-item-core-box .box-stats .box-stats-gfx,
	.node-root.offline .nodes-item-core-box .square-box,
	.node-root.offline .nodes-item-core-box .box-top-tags span.status,
	.node-root.offline .nodes-item-core-box .box-description{
		background-color: #ffdada;
		border-color: red;
	}
	.node-root.tristate .nodes-item-core-box .box-stats .box-stats-gfx,
	.node-root.tristate .nodes-item-core-box .square-box,
	.node-root.tristate .nodes-item-core-box .box-top-tags span.status,
	.node-root.tristate .nodes-item-core-box .box-description{
		background-color: #e2e2e2;
		border-color: #929292;
		color: #5d5d5d;
	}
	.nodes-item-core-box .box-top .box-title{
		font-size: 1.2em;
		font-weight: 600;
		margin-bottom: 5px;
	}
	.nodes-item-core-box .box-top .box-title:hover{color:#66b1dc}
	.nodes-item-core-box .box-top .box-text{line-height:1.3em;white-space:nowrap;overflow:hidden}
	.nodes-item-core-box .box-description{background:#e3f3fc;padding:5px 15px 5px 30px;margin:10px -15px 10px -15px;line-height:1.2em;color:#555;min-height:5.4em;white-space:nowrap}
	.nodes-item-core-box .box-description:hover{overflow:hidden;min-height:5.4em}
	.nodes-item-core-box .box-bottom{padding:0}
	.nodes-item-core-box .box-description:hover .val-workflowName{color:#3c8dbc}
	
	core-cell-list .nodes-item-core-box .box-top{width:50%;float:left}
	core-cell-list .nodes-item-core-box .box-description{width:50%;float:right;margin-top:0}
	core-cell-list .nodes-item-core-box .box-description~div.row{padding-top:10px;clear:both}
	core-cell-list .nodes-item-core-box .box-top .box-icon{top:auto;bottom:-45px;right:-100%;font-size:40px}
	
</style>
<div id="myModalNodes" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog"></div>
</div>
<section class="content-header tao-async-ph">
	<h1>Scheduling<small>Here you can find the list with all workflow execution schedulers.</small></h1>
	<ol class="breadcrumb">
		<li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
		<li class="active">Scheduling</li>
	</ol>
</section>
<!-- Main content -->
<section class="content tao-async-mc">
	<div id="panel-topo-wrapper" class="row collapseX">
		<div class="col-md-12">
			<div class="nav-tabs-custom">
				<ul class="nav nav-tabs visible-xs-block">
					<!--<li class="role-dropdown active">
						<select id="selectNodePanel" name="selectNodePanel" class="form-control form-changepane" title="Select desired node view.">
							<option class="role role-admin" value="all_nodes">All schedulers</option>
						</select>
					</li>-->
				</ul>
				<ul class="nav nav-tabs hidden-xs">
					<!--li class="role role-admin active"><a href="#panel-nodes" data-toggle="tab" data-action="all_nodes" aria-expanded="true">All schedulers</a></li-->
				</ul>
				<div class="tab-content">
					<div class="tab-pane active" id="panel-nodes">
						<div class="row">
							<div class="col-md-12" id="list-master-controls">
								<div class="box-tools pull-left">
									<button class="btn btn-master-tool text-black" data-action="op-plus" data-toggle="tooltip" data-original-title="Add new processing component"><i class="fa fa-plus"></i></button>
								</div>
								<div class="box-tools pull-left">
									<button class="btn btn-master-tool text-black" data-action="op-filter" data-toggle="tooltip" data-original-title="Filter by tags"><i class="fa fa-filter"></i><span class="label label-warning val-count-filters" style="display:none;">0</span></button>
								</div>
								<div class="box-tools pull-left">
									<form class="search-container collapse" action="">
										<input id="search-box" type="text" class="search-box" name="q" placeholder="Search by label" />
										<label for="search-box"><i class="fa fa-search search-icon" aria-hidden="true"></i></label>
										<input type="submit" id="search-submit" />
									</form>
								</div>
								<div class="box-tools pull-right">
									<button class="btn btn-master-tool text-black" data-action="refresh-list" data-toggle="tooltip" data-original-title="Refresh"><i class="fa fa-refresh fa-spin-hover"></i></button>
									<button class="btn btn-master-tool text-black" data-action="view-list" data-toggle="tooltip" data-original-title="List view"><i class="fa fa-list"></i></button>
									<button class="btn btn-master-tool text-black" data-action="view-table" data-toggle="tooltip" data-original-title="Grid view"><i class="fa fa-table"></i></button>
								</div>
							</div>
						</div>
						<div class="row">
							<div class="col-md-12 like collapse">
								<span data-tag="tag">Label like: <strong class="val-q"></strong>&nbsp;<i class="fa fa-times fa-fw clear-search" aria-hidden="true"></i></span>
							</div>
							<div class="col-md-12 tags collapse">
								<span class="collapse" data-tag="tag">tag<i class="fa fa-check fa-fw" aria-hidden="true"></i></span>
							</div>
						</div>
						<div class="row" id="list-work-users">
							<div class="col-sm-12">
								<div class="box box-success">
									<div class="box-header">
										<i class="fa fa-clock-o" aria-hidden="true"></i>
										<h3 class="box-title">Schedulers - <span class="val-itemfrom">0</span> to <span class="val-itemto">0</span> of <span class="val-itemscount">0</span></h3>
										<div class="box-tools pull-right nppaginatedcells-order collapse" data-toggle="tooltip" title="Change order"></div>
									</div>
									<div class="nppaginatedcells-empty callout callout-empty">
										<p>Schedulers list is empty. <span class="results-empty">You do not have any node.</span><span class="filter-results-empty collapse">Your current selection returned no results.</span></p>
									</div>
									<div class="box-body chat users-box">
										<div class="nppaginatedcells-panel-body">
										</div>
										<div class="cell-templates collapse">
											<core-cell-list>
												<div class="col-md-12 col-sm-12">
													<div class="nodes-item-core-box">
														<div class="box-top-tags">
															<span>Tag1</span><span>Tag2</span><span>Tag3</span>
														</div>
														<div class="box-top">
															<div class="box-title"><span class="val-friendlyName">Lynx Node</span></div>
															<div class="box-subtitle"><span class="val-id"></span></div>
															<div class="box-icon">
																<i class="fa fa-clock-o"></i>
															</div>
															<div class="box-text">
																Start time: <strong><span class="val-startTime"></span></strong><br/>
																Repeat interval: <strong><span class="val-repeatInterval"></span></strong><br/>
																Scheduling mode: <strong><span class="val-mode"></span></strong>
															</div>
														</div>
														<div class="box-description row">
															<strong style="margin-left:-15px">Workflow information:</strong><br/>
															<span class="val-workflowName"></span><br/>
															Last execution time: <strong><span class="val-lastExecutionTime"></span></strong><br/>
															Last execution status: <strong><span class="val-lastExecutionStatus"></span></strong>
														</div>
														<div class="row">
															<div class="col-md-6 col-sm-12 col-xs-12">
																<div>
																	<button type="button" class="btn btn-primary btn-sm btn-flat btn-action btn-nodeop" data-action="edit"><i class="fa fa-pencil fa-fw" aria-hidden="true"></i><span class="span-muted">&nbsp;Edit</span></button>
																	<button type="button" class="btn btn-primary btn-sm btn-flat btn-action btn-nodeop collapse only-v-1" data-action="pause"><i class="fa fa-pause fa-fw" aria-hidden="true"></i><span class="span-muted">&nbsp;Pause</span></button>
																	<button type="button" class="btn btn-primary btn-sm btn-flat btn-action btn-nodeop collapse only-v-0" data-action="resume"><i class="fa fa-play fa-fw" aria-hidden="true"></i><span class="span-muted">&nbsp;Resume</span></button>
																	<button type="button" class="btn btn-primary btn-sm btn-flat btn-action btn-nodeop" data-action="delete"><i class="fa fa-trash-o fa-fw" aria-hidden="true"></i><span class="span-muted">&nbsp;Delete</span></button>
																</div>
															</div>
														</div>
													</div>
												</div>
											</core-cell-list>
											<core-cell-grid>
												<div class="col-lg-3 col-md-4 col-sm-6">
													<div class="nodes-item-core-box">
														<div class="box-top-tags">
															<span>Tag1</span><span>Tag2</span><span>Tag3</span>
														</div>
														<div class="box-top">
															<div class="box-title"><span class="val-friendlyName">GEOCODED TERRAIN CORRECTED SIGMA0</span></div>
															<div class="box-subtitle">Id: <span class="val-id"></span></div>
															<div class="box-icon">
																<i class="fa fa-clock-o"></i>
															</div>
															<div class="box-text">
																Start time: <strong><span class="val-startTime"></span></strong><br/>
																Repeat interval: <strong><span class="val-repeatInterval"></span></strong><br/>
																Scheduling mode: <strong><span class="val-mode"></span></strong>
															</div>
														</div>
														<div class="box-description">
															<strong style="margin-left:-15px">Workflow information:</strong><br/>
															<span class="val-workflowName"></span><br/>
															Last execution time: <strong><span class="val-lastExecutionTime"></span></strong><br/>
															Last execution status: <strong><span class="val-lastExecutionStatus"></span></strong>
														</div>
														<div class="box-bottom">
															<div class="">
																<button type="button" class="btn btn-primary btn-sm btn-flat btn-action btn-nodeop" data-action="edit"><i class="fa fa-pencil fa-fw" aria-hidden="true"></i><span class="span-muted collapse">&nbsp;Edit</span></button>
																<button type="button" class="btn btn-primary btn-sm btn-flat btn-action btn-nodeop collapse only-v-1" data-action="pause"><i class="fa fa-pause fa-fw" aria-hidden="true"></i><span class="span-muted collapse">&nbsp;Pause</span></button>
																<button type="button" class="btn btn-primary btn-sm btn-flat btn-action btn-nodeop collapse only-v-0" data-action="resume"><i class="fa fa-play fa-fw" aria-hidden="true"></i><span class="span-muted collapse">&nbsp;Resume</span></button>
																<button type="button" class="btn btn-primary btn-sm btn-flat btn-action btn-nodeop" data-action="delete"><i class="fa fa-trash-o fa-fw" aria-hidden="true"></i><span class="span-muted collapse">&nbsp;Delete</span></button>
															</div>
														</div>
													</div>
												</div>
											</core-cell-grid>
										</div>
									</div>
									<div class="box-footer clearfix no-border">
										<div class="box-tools pull-right">
											<ul class="nppaginatedcells-panel-pagination pagination pagination-sm inline">
												<li><a href="#" data-page="prev">«</a></li>
												<li class="active"><a href="#" data-page="0">1</a></li>
												<li><a href="#" data-page="1">2</a></li>
												<li><a href="#" data-page="2">3</a></li>
												<li><a href="#" data-page="next">»</a></li>
											</ul>
										</div>
									</div>
									<div class="box-notification"><p><span>List updated</span></p></div>
								</div>
							</div>
						</div>
					</div><!-- /.tab-pane -->

					<div class="tab-pane" id="panel-nodesX">
					</div><!-- /.tab-pane -->

				</div>
			</div>
		</div>
	</div>
</section>
<script>
	var deleteNodeById = function (id) {
		$.ajax({
			cache: false,
			url: baseRestApiURL + "scheduling/remove?id=" + id,
			dataType : 'json',
			type: 'GET',
			headers: {
				"Accept": "application/json",
				"Content-Type": "application/json",
				"X-Auth-Token": window.tokenKey
			},
			error : function (jqXHR, textStatus, errorThrown) {
				console.log("error");
				if(jqXHR.status === 500 ){
					showMsg("Unable to delete scheduler. Please try again.", "ERROR");
				} else {
					alert('An error has occurred, please try again or contact app admin.');
				}
			},
			success: function(data) {
				if (data.status == responseStatus.success) {
					showMsg("Workflow execution scheduler successfully deleted.", "SUCCESS");
				} else {
					alert('An error has occurred, please try again or contact app admin.');
				}
				panelComp.refreshData();
			}
		});
	};
	var manageNodeStatus = function (dna, action) {
		if (!dna && !dna.id) {
			showMsg("Invalid action requested.", "FAILED");
			return;
		}
		$.ajax({
			cache: false,
			url: baseRestApiURL + "scheduling/" + action + "?id=" + dna.id,
			dataType : 'json',
			type: 'GET',
			headers: { "Accept": "application/json", "Content-Type": "application/json", "X-Auth-Token": window.tokenKey },
			error: function (jqXHR, textStatus, errorThrown) {
				if (jqXHR.status === 500 ) {
					showMsg("Unable to perform requested action. Please try again.", "ERROR");
					return;
				}
				showMsg("Unknown error. Unable to update scheduler's status. Please try again.", "ERROR");
			},
			success: function(response, textStatus, jqXHR) {
				if (response.status == responseStatus.success) {
					showMsg(response.message, "SUCCESS");
					panelComp.refreshData();
				} else if (response.status == responseStatus.fail) {
					showMsg(response.message, "FAILED");
				}
			}
		});
	};
	var myModalNodesOpShow = function(operationid, args){
		var $modal = $("#myModalNodes");
		$(".modal-dialog",$modal).removeClass("modal-lg");
		var rm_contentUrl = '';
		window.userOpStack = [];
		
		if (operationid === "op-plus") {
			window.userOpStack = [{ "dna": void 0, "action": "op-plus" }];
			rm_contentUrl="./fragments/scheduling-plus.fragment.html?" + Math.random();
		}
		if (operationid === "edit") {
			window.userOpStack = [{ "dna": args.dna, "action": "op-edit" }];
			rm_contentUrl="./fragments/scheduling-plus.fragment.html?" + Math.random();
		}
		if (rm_contentUrl !== '') {
			$.ajax({
				url: rm_contentUrl,
				success: function(result) {
					var rmContent = result;
					if (rmContent !== '') {
						$modal.find('.modal-dialog').html(rmContent);
					} else {
						alert("Could not retrive needed data from server.");
						return e.preventDefault();
					}
					$modal.modal('show');
				}
			});
		} else {
			alert("TAO - Operation mismatch");
		}
	};
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	$(document).ready(function () {
		var urls = [ baseRestApiURL + "scheduling/list" ];
		window.panelComp = $('#panel-nodes').npPaginatedCells({
			headerUser: taoUserProfile.username,
			url: urls,
			viewMode: prefferences.viewMode,
			filterAttribute: "friendlyName",
			order:[
				{
					"label":"Name ascending",
					"objAttributeName":"friendlyName",
					"direction":"ASC"
				},
				{
					"label":"Name descending",
					"objAttributeName":"friendlyName",
					"direction":"DSC"
				}
			],
			doDataPreprocessing: function (data) {
				if (data) {
					for (var i = 0; i < data.length; i++) {
						data[i].startTime = moment.utc(data[i].startTime).format("YYYY-MM-DD HH:mm:ss");
						if (!data[i].tags) data[i].tags = [];
						data[i].tags.push(data[i].mode);
						data[i].tags.push(data[i].state == "NORMAL" ? "RUNNING" : data[i].state);
						data[i].lastExecutionTime = data[i].jobs.length > 0 ? moment.utc(data[i].jobs[data[i].jobs.length - 1].endTime).format("YYYY-MM-DD HH:mm:ss") : "-";
						data[i].lastExecutionStatus = data[i].jobs.length > 0 ? data[i].jobs[data[i].jobs.length - 1].status : "-";
					}
					return data;
				} else {
					return [];
				}
			},
			doAction: function (action, args) {
				if (action === "op-plus") myModalNodesOpShow(action, args);
				if (action === "edit"   ) myModalNodesOpShow(action, args);
				if (action === "delete" ) {
					$('#confirm-dialog').modal('confirm', {
						msg:"Are you sure you want to delete workflow execution scheduler: <strong>" + args.dna.friendlyName + "</strong>?",
						callbackConfirm: function () {
							deleteNodeById(args.dna.id);
						},
						callbackCancel: function () {}
					});
				}
				if (action === "resume" || action == "pause") {
					$('#confirm-dialog').modal('confirm', {
						msg:"Are you sure you want to " + action + " workflow execution scheduler:<br/><strong>" + args.dna.friendlyName + "</strong>?",
						callbackConfirm: function () {
							manageNodeStatus(args.dna, action);
						},
						callbackCancel: function () {}
					});
				}
			},
			doCustomRender: function($elClone, elX) {
				$(".box-top-tags span:last-child", $elClone).addClass("status");
				$("button[data-action='resume']" , $elClone).removeClass("collapse");
				
				$(".val-friendlyName", $elClone).attr("title", elX.friendlyName);
				$(".box-description", $elClone).attr("title", elX.workflowName + "\n" + elX.lastExecutionTime + "\n" + elX.lastExecutionStatus);
				
				if (elX.state == "NORMAL") {
					// show "Pause" node action
					$elClone.addClass("online");
					$("button[data-action='pause']", $elClone).removeClass("collapse");
					$("button[data-action='resume']" , $elClone).addClass("collapse");
				} else if (elX.state == "PAUSED") {
					$elClone.addClass("offline");
					// show "Resume" node action
					$("button[data-action='pause']", $elClone).addClass("collapse");
					$("button[data-action='resume']" , $elClone).removeClass("collapse");
				} else {
					$elClone.addClass("tristate");
					// show "Resume" node action
					$("button[data-action='pause']", $elClone).addClass("collapse");
					$("button[data-action='resume']" , $elClone).removeClass("collapse");
				}
			}
		});
	});
	//# sourceURL=scheduling-admin2.fragment.js
</script>
